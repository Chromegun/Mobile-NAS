#!/bin/sh

# GitHub 및 경로 정의
GITHUB_USER="Chromegun"
REPO="Mobile-NAS"
RAW_URL="https://raw.githubusercontent.com/$GITHUB_USER/$REPO/main"

CONF_FILE="/etc/mobile-nas/config.conf"
UI_FILE="/usr/local/lib/mobile-nas/ui.sh"
SERV_FILE="/usr/local/lib/mobile-nas/services.sh"
UTIL_FILE="/usr/local/lib/mobile-nas/utils.sh"

# 1. 설정 파일 로드 (변수값들을 메모리에 올림)
source $CONF_FILE

# 2. 모듈 로드 (함수들을 메모리에 올림)
source $UI_FILE
source $SERV_FILE
source $UTIL_FILE

# 초기 무결성 확인 및 모듈 로드
for f in "$CONF_FILE" "$UI_FILE" "$SERV_FILE" "$UTIL_FILE"; do
    [ ! -f "$f" ] && mkdir -p $(dirname "$f") && curl -sSL "$RAW_URL/$(basename $f)" -o "$f"
done

. "$CONF_FILE"
. "$UI_FILE"
. "$SERV_FILE"
. "$UTIL_FILE"

export LANG=ko_KR.UTF-8
export LC_ALL=ko_KR.UTF-8

# 인자 처리
case "$1" in
    log) view_logs; exit 0 ;;
    wizard) samba_wizard; echo "✅ 설정 완료"; exit 0 ;;
esac

init_ui
draw_screen 10 "시스템 무결성 및 업데이트 확인 중..."
check_integrity
auto_update

draw_screen 40 "Samba 설정 및 서비스 구성 중..."
samba_wizard
run_samba

draw_screen 70 "네트워크 장치 및 외부 접속 엔진 가동 중..."
run_network_tun
run_tailscale

draw_screen 100 "서버 가동 완료 및 상태 점검 중..."
sleep 1

close_ui
clear
draw_line
printf " %-58s \n" "      ✅ $SERVER_NAME 가동 완료"
draw_line
echo ""
if health_check; then
    printf "  - 시스템 상태: %-15s\n" "안정적 (✅)"
    printf "  - 내부 주소: %-15s\n" "$(hostname -I | awk '{print $1}')"
    printf "  - 외부 주소: %-15s\n" "$(tailscale ip -4 2>/dev/null || echo '인증 필요')"
else
    printf "  - 시스템 상태: %-15s\n" "이상 발생 (❌)"
    echo "    명령어 'nas-start log'로 상세 에러를 확인하세요."
fi
draw_line
